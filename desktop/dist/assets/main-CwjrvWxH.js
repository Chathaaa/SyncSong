import"./modulepreload-polyfill-B5Qt9EMX.js";const oe="modulepreload",ae=function(t){return"/"+t},Pt={},I=function(e,o,n){let a=Promise.resolve();if(o&&o.length>0){let l=function(p){return Promise.all(p.map(f=>Promise.resolve(f).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),s=r?.nonce||r?.getAttribute("nonce");a=l(o.map(p=>{if(p=ae(p),p in Pt)return;Pt[p]=!0;const f=p.endsWith(".css"),y=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${y}`))return;const h=document.createElement("link");if(h.rel=f?"stylesheet":oe,f||(h.as="script"),h.crossOrigin="",h.href=p,s&&h.setAttribute("nonce",s),document.head.appendChild(h),f)return new Promise((C,ne)=>{h.addEventListener("load",C),h.addEventListener("error",()=>ne(new Error(`Unable to preload CSS for ${p}`)))})}))}function u(r){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r}return a.then(r=>{for(const s of r||[])s.status==="rejected"&&u(s.reason);return e().catch(u)})},ie="https://accounts.spotify.com/api/token";let bt=!1,vt="",Y=.8;function se(){return localStorage.getItem("spotify:client_id")||"e87ab2180d5a438ba6f23670e3c12f3d"}function re(){const t=localStorage.getItem("spotify:access_token")||"",e=Number(localStorage.getItem("spotify:expires_at")||"0");return t?!e||Date.now()<e-6e4:!1}async function Lt(){const t=localStorage.getItem("spotify:refresh_token")||"";if(!t)throw new Error("No Spotify refresh token (need to connect once).");const e=se(),o=await fetch(ie,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:e,grant_type:"refresh_token",refresh_token:t})}),n=await o.json().catch(()=>({}));if(!o.ok)throw new Error(n?.error_description||"Spotify refresh failed");return n.access_token&&localStorage.setItem("spotify:access_token",n.access_token),n.expires_in&&localStorage.setItem("spotify:expires_at",String(Date.now()+n.expires_in*1e3)),n.refresh_token&&localStorage.setItem("spotify:refresh_token",n.refresh_token),n.access_token}async function xt(){return re()?localStorage.getItem("spotify:access_token"):Lt()}function at(){const t=localStorage.getItem("spotify:access_token")||"",e=Number(localStorage.getItem("spotify:expires_at")||"0");return!t||e&&Date.now()>e-1e4?null:t}function ce(){return Math.random().toString(16).slice(2)+Date.now().toString(16)}async function K(t,e={}){const o=await xt();if(!o)throw new Error("Spotify not connected. Click Connect Spotify.");const n=await fetch(`https://api.spotify.com/v1${t}`,{method:e.method||"GET",headers:{Authorization:`Bearer ${o}`,...e.headers||{}},body:e.body});if(n.status===204)return null;const a=await n.json().catch(()=>({}));if(!n.ok)throw new Error(a?.error?.message||`Spotify API error: ${n.status}`);return a}async function O(t,e={}){return K(t,e)}let A=null,b=null,it=null;async function $t(){b&&await O("/me/player",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({device_ids:[b],play:!1})})}window.onSpotifyWebPlaybackSDKReady=()=>{console.log("[spotify] Web Playback SDK ready")};function Ut({timeoutMs:t=15e3}={}){return new Promise((e,o)=>{const n=Date.now(),a=setInterval(()=>{b?(clearInterval(a),e(b)):Date.now()-n>t&&(clearInterval(a),o(new Error("Spotify device_id not ready yet.")))},100)})}async function v(){if(A)return A;if(!at())throw new Error("Spotify not connected (token missing/expired).");if(!window.Spotify||!window.Spotify.Player)throw new Error("Spotify SDK not loaded (check CSP + script tag).");if(A=new window.Spotify.Player({name:"SyncSong (In-App)",getOAuthToken:o=>o(at()||""),volume:.8}),it=it||new Promise(o=>{A.addListener("ready",async({device_id:n})=>{b=n,console.log("[spotify] ready device_id=",n);try{await $t()}catch(a){console.warn("[spotify] transfer failed:",a)}o(n)})}),A.addListener("not_ready",({device_id:o})=>{console.log("[spotify] device offline",o),b===o&&(b=null)}),A.addListener("authentication_error",({message:o})=>console.error("[spotify] auth error",o)),!await A.connect())throw new Error("Spotify player connect() failed.");return A}async function Dt(){if(await v(),await(it||Ut()),!!b&&!(bt&&vt===b)){try{await O(`/me/player/shuffle?state=false&device_id=${encodeURIComponent(b)}`,{method:"PUT"})}catch{}try{await O(`/me/player/repeat?state=off&device_id=${encodeURIComponent(b)}`,{method:"PUT"})}catch{}bt=!0,vt=b}}async function Nt(t){if(!t)throw new Error("Missing spotifyUri on track.");if(await v(),await(it||Ut()),!b)throw new Error("Spotify device_id not ready yet.");await Dt(),await O(`/me/player/play?device_id=${encodeURIComponent(b)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({uris:[t]})})}async function le(){if(!at())throw new Error("Spotify not connected. Click Connect Spotify.");return{playlists:((await K("/me/playlists?limit=50")).items||[]).map(a=>({id:a.id,name:a.name}))}}async function ue(t){return localStorage.setItem("syncsong:lastSpotifyPlaylistId",String(t)),{tracks:((await K(`/playlists/${t}/tracks?limit=100`)).items||[]).map(a=>a.track).filter(Boolean).map(a=>({id:ce(),source:"spotify",title:a.name,artist:a.artists?.[0]?.name||"Unknown",album:a.album?.name||"",durationMs:a.duration_ms||0,spotifyTrackId:a.id,spotifyUri:a.uri,artworkUrl:a.album?.images?.[0]?.url||""}))}}async function pe(t){if(t.source==="spotify"&&t.spotifyUri)return t.spotifyUri;if(t.isrc){const u=encodeURIComponent(`isrc:${t.isrc}`),s=(await K(`/search?type=track&limit=1&q=${u}`))?.tracks?.items?.[0];if(s?.uri)return s.uri}const e=encodeURIComponent(`${t.title} ${t.artist}`.trim()),n=(await K(`/search?type=track&limit=5&q=${e}`))?.tracks?.items||[];return n.length&&n[0]?.uri||null}async function de(){const t="e87ab2180d5a438ba6f23670e3c12f3d",e=`${window.location.origin}/spotify-callback.html`,o=crypto.getRandomValues(new Uint8Array(32)),n=btoa(String.fromCharCode(...o)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");async function a(y){const h=new TextEncoder().encode(y),C=await crypto.subtle.digest("SHA-256",h);return new Uint8Array(C)}function u(y){return btoa(String.fromCharCode(...y)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}const r=u(await a(n)),s=Math.random().toString(16).slice(2)+Date.now().toString(16);localStorage.setItem("spotify:pkce_verifier",n),localStorage.setItem("spotify:client_id",t),localStorage.setItem("spotify:redirect_uri",e),localStorage.setItem("spotify:oauth_state",s);const l=["playlist-read-private","playlist-read-collaborative","streaming","user-modify-playback-state","user-read-playback-state"].join(" "),p=`https://accounts.spotify.com/authorize?client_id=${encodeURIComponent(t)}&response_type=code&redirect_uri=${encodeURIComponent(e)}&code_challenge_method=S256&code_challenge=${encodeURIComponent(r)}&scope=${encodeURIComponent(l)}&state=${encodeURIComponent(s)}&show_dialog=true`;if(!window.open(p,"spotify_auth","width=520,height=680"))throw new Error("Popup blocked. Allow popups and try again.")}async function fe(){await(await v()).resume()}async function ye(){await(await v()).pause()}async function me(t){await(await v()).seek(Math.max(0,Math.floor(t*1e3)))}async function we(){await v(),await O("/me/player/next",{method:"POST"})}async function ge(){await v(),await O("/me/player/previous",{method:"POST"})}async function he(){return(await v()).getCurrentState()}async function ke(t){try{const e=await v();if(!e?.setVolume)return;Y=Math.max(0,Math.min(1,Number(t))),await e.setVolume(Y)}catch{}}async function Se(t=450){try{const e=await v();if(!e?.getVolume||!e?.setVolume)return;const o=await e.getVolume();Y=typeof o=="number"?o:Y,await e.setVolume(0),setTimeout(()=>{try{e.setVolume(Y)}catch{}},t)}catch{}}const $=Object.freeze(Object.defineProperty({__proto__:null,ensureSpotifyWebPlayer:v,getSpotifyAccessToken:at,loadSpotifyPlaylistsAndTracks:le,loadSpotifyTracks:ue,spotifyApi:O,spotifyDuckForTransition:Se,spotifyEnsureAccessToken:xt,spotifyFetch:K,spotifyFindUriForTrack:pe,spotifyGetPlaybackState:he,spotifyNext:we,spotifyPause:ye,spotifyPlay:fe,spotifyPlayUriInApp:Nt,spotifyPreparePlaybackDevice:Dt,spotifyPrev:ge,spotifyRefreshAccessToken:Lt,spotifySeek:me,spotifySetVolume:ke,spotifyTransferToThisAppDevice:$t,spotifyWebConnect:de},Symbol.toStringTag,{value:"Module"}));let It=null,k={isPlaying:!1,positionMs:0,durationMs:0},ft=!1;const Rt="https://syncsong-2lxp.onrender.com/apple/dev-token";function ct(){return localStorage.getItem("syncsong:appleUserToken")||null}async function qt(){const t=await fetch(Rt);if(!t.ok)throw new Error("Failed to fetch Apple developer token");const e=await t.json();if(!e?.token)throw new Error("Apple developer token missing from server response");return localStorage.setItem("syncsong:appleDevToken",e.token),e.token}async function lt(){const t=async(a,u=15e3)=>{const r=Date.now();for(;Date.now()-r<u;){const s=a();if(s)return s;await new Promise(l=>setTimeout(l,50))}return null};if(!await t(()=>window.MusicKit&&typeof window.MusicKit.configure=="function"))throw new Error("MusicKit not ready yet (script still loading).");let o=localStorage.getItem("syncsong:appleDevToken");o||(o=await qt()),window.__appleConfiguredPromise||(window.__appleConfiguredPromise=window.MusicKit.configure({developerToken:o,app:{name:"SyncSong",build:"1.0.0"}}).then(()=>{window.__appleConfigured=!0})),await window.__appleConfiguredPromise;const n=await t(()=>window.MusicKit.getInstance&&window.MusicKit.getInstance(),15e3);if(!n)throw new Error("MusicKit instance not available (not initialized yet).");return n}async function ht(t){const e=localStorage.getItem("syncsong:appleDevToken"),o=ct();if(!e)throw new Error("Apple dev token missing. Click Connect Apple.");if(!o)throw new Error("Apple not authorized. Click Connect Apple.");const n=await fetch(`https://api.music.apple.com/v1${t}`,{headers:{Authorization:`Bearer ${e}`,"Music-User-Token":o}}),a=await n.json().catch(()=>({}));if(!n.ok){const u=a?.errors?.[0]?.detail||`Apple Music API error: ${n.status}`;throw new Error(u)}return a}const B=new Map;async function M(){await lt();const t=window.MusicKit.getInstance();if(!ct()){const e=await t.authorize();localStorage.setItem("syncsong:appleUserToken",e)}return It!==t&&(It=t,ft=!1),mt(t),t}async function yt(t){const e=localStorage.getItem("syncsong:appleDevToken");if(!e)throw new Error("Apple dev token missing.");const o=await fetch(`https://api.music.apple.com/v1${t}`,{headers:{Authorization:`Bearer ${e}`}}),n=await o.json().catch(()=>({}));if(!o.ok)throw new Error(n?.errors?.[0]?.detail||`Apple catalog error: ${o.status}`);return n}function Pe(t){return t.isrc||t.catalogId||t.sourceId||t.spotifyTrackId||`${(t.title||"").toLowerCase()}|${(t.artist||"").toLowerCase()}|${(t.album||"").toLowerCase()}`}async function Ot(t){if(t.catalogId)return t.catalogId;const e=Pe(t);if(B.has(e))return B.get(e);const o=await M();if(!o)throw new Error("Apple Music not initialized. Click Connect Apple and try again.");const n=o.storefrontId||"us";let a=null;if(t.isrc)try{a=await yt(`/catalog/${n}/songs?filter[isrc]=${encodeURIComponent(t.isrc)}&limit=1`);const p=a?.data?.[0]?.id||"";if(p)return B.set(e,p),t.catalogId=p,p}catch{}const u=encodeURIComponent(`${t.title} ${t.artist}`.trim());a=await yt(`/catalog/${n}/search?types=songs&limit=5&term=${u}`);const s=a?.results?.songs?.data?.[0]?.id||"";if(!s)throw new Error("Could not resolve Apple catalog song id (search returned nothing).");return B.set(e,s),t.catalogId=s,s}async function Ft(t){const e=await M(),o=await Ot(t);t?.durationMs&&(k.durationMs=Number(t.durationMs)||k.durationMs),k.positionMs=0,k.isPlaying=!0,await e.setQueue({song:o}),await e.play(),setTimeout(()=>{window.MusicKit.getInstance()},800);try{k.isPlaying=e.player?.playbackState===window.MusicKit?.PlaybackStates?.playing,k.positionMs=Math.floor((e.player?.currentPlaybackTime||0)*1e3);const n=Math.floor((e.player?.currentPlaybackDuration||0)*1e3);n>0&&(k.durationMs=n)}catch{}}async function U(){await(await M()).pause()}async function W(){await(await M()).play()}async function be(){(await M()).skipToNextItem()}async function ve(){return await lt(),ct()?{playlists:((await ht("/me/library/playlists?limit=100")).data||[]).map(n=>({id:n.id,name:n.attributes?.name||"Untitled"}))}:{playlists:[],tracks:[],note:"Click “Connect Apple” to load your library playlists."}}async function Ie(t){localStorage.setItem("syncsong:lastApplePlaylistId",String(t));const o=(await ht(`/me/library/playlists/${t}/tracks?limit=100`)).data||[];function n(r){const s=r.attributes?.name||"",l=r.attributes?.artistName||"",p=encodeURIComponent(`${s} ${l}`.trim());return p?`https://music.apple.com/search?term=${p}`:""}function a(){return Math.random().toString(16).slice(2)+Date.now().toString(16)}return{tracks:o.map(r=>{const s=r.attributes?.url||"",l=r.attributes?.artwork,p=l?l.url.replace("{w}","300").replace("{h}","300"):"";return{id:a(),source:"apple",sourceId:r.id,isrc:r.attributes?.isrc||"",title:r.attributes?.name||"Unknown",artist:r.attributes?.artistName||"Unknown",album:r.attributes?.albumName||"",durationMs:r.attributes?.durationInMillis||0,url:s||n(r),catalogId:"",artworkUrl:p}})}}async function _e(t){(await M()).seekToTime(Number(t)||0)}async function Te(){(await M()).skipToPreviousItem()}async function Ee(){const t=await M();mt(t);const e=t?.playbackTime??t?.currentPlaybackTime;typeof e=="number"&&Number.isFinite(e)&&(k.positionMs=Math.floor(e*1e3));const o=t?.playbackDuration??t?.currentPlaybackDuration;typeof o=="number"&&Number.isFinite(o)&&o>0&&(k.durationMs=Math.floor(o*1e3));const n=t?.playbackState,a=window.MusicKit?.PlaybackStates?.playing??2;return typeof n<"u"&&(k.isPlaying=n===a),{...k}}function mt(t){ft||!t?.addEventListener||(ft=!0,t.addEventListener("playbackStateDidChange",e=>{const o=e?.state??t?.playbackState,n=window.MusicKit?.PlaybackStates?.playing??2;k.isPlaying=o===n}),t.addEventListener("playbackTimeDidChange",e=>{const o=e?.playbackTime??e?.currentPlaybackTime??t?.playbackTime??t?.currentPlaybackTime;typeof o=="number"&&Number.isFinite(o)&&(k.positionMs=Math.floor(o*1e3));const n=e?.playbackDuration??e?.currentPlaybackDuration??t?.playbackDuration??t?.currentPlaybackDuration;typeof n=="number"&&Number.isFinite(n)&&n>0&&(k.durationMs=Math.floor(n*1e3))}),t.addEventListener("mediaItemDidChange",e=>{k.positionMs=0;const o=e?.playbackDuration??e?.currentPlaybackDuration??t?.playbackDuration??t?.currentPlaybackDuration;typeof o=="number"&&Number.isFinite(o)&&o>0&&(k.durationMs=Math.floor(o*1e3))}))}const X=Object.freeze(Object.defineProperty({__proto__:null,APPLE_DEV_TOKEN_URL:Rt,appleCatalogFetch:yt,appleCatalogIdCache:B,appleEnsureAuthorized:M,appleFetch:ht,appleGetPlaybackState:Ee,appleNext:be,applePause:U,applePlay:W,applePlayTrack:Ft,applePrev:Te,appleResolveCatalogSongId:Ot,appleSeek:_e,ensureAppleConfigured:lt,fetchAppleDeveloperToken:qt,getAppleUserToken:ct,loadApplePlaylistsAndTracks:ve,loadAppleTracks:Ie},Symbol.toStringTag,{value:"Module"}));function Me({getPlaybackSource:t,getNowPlaying:e,onNextShared:o,onPrevShared:n}){async function a(){const f=t();if(f==="spotify"){await(await v()).resume();return}if(f==="apple"){await W();return}}async function u(){const f=t();if(f==="spotify"){await(await v()).pause();return}if(f==="apple"){await U();return}}async function r(f){const y=t();if(y==="spotify"){await(await v()).seek(Math.max(0,Math.floor(f*1e3)));return}if(y==="apple"){const{appleSeek:h}=await I(async()=>{const{appleSeek:C}=await Promise.resolve().then(()=>X);return{appleSeek:C}},void 0);await h(f);return}}async function s(){if(typeof o=="function")return o()}async function l(){if(typeof n=="function")return n()}async function p(){return a()}return{playerPlay:a,playerPause:u,playerSeek:r,playerNext:s,playerPrev:l,playerToggle:p}}const Ce="wss://syncsong-2lxp.onrender.com",Ae=Me({getPlaybackSource:()=>d,getNowPlaying:()=>c,onNextShared:()=>Be(),onPrevShared:()=>Ye()}),{playerPlay:z,playerPause:F,playerSeek:Le,playerNext:Kt,playerPrev:xe}=Ae;let _,w=null,S=null,g=null,m=[],c=null,P=localStorage.getItem("syncsong:lastSource")||"spotify",N=[],V=[],Vt=[],wt="",tt=null,G=!1,Q=!0,et=!1,H=0,j=0,_t="",Tt="",ut="",R=!1,pt=!1,Ht=0,J="",q=!0;const $e="syncsong:lastSource",Ue="syncsong:lastItunesPlaylistIndex",De="syncsong:lastSpotifyPlaylistId",Ne="syncsong:lastApplePlaylistId",Re="syncsong:appleUserToken",jt="syncsong:playbackSource";let d=localStorage.getItem(jt)||"apple";const i=t=>document.getElementById(t);function T(t,e){return!_||_.readyState!==WebSocket.OPEN?!1:(_.send(JSON.stringify({type:t,payload:e})),!0)}function L(t){return String(t??"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[e])}function st(t){if(t==null)return"";const e=Math.floor(t/1e3),o=Math.floor(e/60),n=e%60;return`${o}:${String(n).padStart(2,"0")}`}function Et(t){document.body.classList.toggle("scrubbing",t),i("npProgress")?.classList.toggle("scrubbing",t)}async function Bt(t){try{return await navigator.clipboard.writeText(t),!0}catch{const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.focus(),e.select();try{const o=document.execCommand("copy");return document.body.removeChild(e),o}catch{return document.body.removeChild(e),!1}}}function Yt(){return`Join my SyncSong session: ${S}

Open the app → paste the code → Join.`}function zt(){const t=i("copySession");if(t){if(!S){t.style.display="none";return}t.style.display="inline-block"}}async function Mt(){const t=i("copySession");if(!t||!S)return;if(await Bt(Yt())){const o=t.textContent;t.textContent="Copied!",setTimeout(()=>t.textContent=o,1200)}}function Ct(){const t=w&&g&&w===g;i("sessionMeta").textContent=S?`Session: ${S} ${t?"(Host)":""}`:"No session",zt()}function Gt(){_=new WebSocket(Ce),_.onopen=()=>{i("sessionMeta").textContent="Connected",G=!1},_.onmessage=t=>{const e=JSON.parse(t.data);if(e.type==="hello"){w=e.userId;return}if(e.type==="session:created"){if(S=e.sessionId,G=!1,Ct(),tt){const o=tt;tt=null,T("queue:add",{sessionId:S,track:o}),setTimeout(()=>Mt(),50)}else setTimeout(()=>Mt(),50);return}if(e.type==="session:state"){S=e.sessionId,g=e.hostUserId,m=e.queue||[],c=e.nowPlaying||null,Ct(),At(),E(),rt();return}if(e.type==="queue:updated"){m=e.queue||[],At();return}if(e.type==="nowPlaying:updated"){c=e.nowPlaying||null,E(),rt();return}e.type==="error"&&(i("sessionMeta").textContent=`Error: ${e.message}`)},_.onclose=()=>{i("sessionMeta").textContent="Disconnected (reconnect in 2s)",setTimeout(Gt,2e3)}}function kt(){i("sourceSpotify")?.classList.toggle("active",P==="spotify"),i("sourceApple")?.classList.toggle("active",P==="apple"),i("connectSpotify").style.display=P==="spotify"?"inline-block":"none",i("connectApple").style.display=P==="apple"?"inline-block":"none"}function Wt(){const t=i("toggleLoop");t&&(t.textContent=`Loop: ${Q?"On":"Off"}`)}function gt(){const t=i("musicPlaylists");if(!t||(t.innerHTML="",N.forEach(a=>{const u=document.createElement("option");u.value=String(a.id),u.textContent=a.name,t.appendChild(u)}),!N.length))return;let e=null;P==="itunes"&&(e=localStorage.getItem(Ue)),P==="spotify"&&(e=localStorage.getItem(De)),P==="apple"&&(e=localStorage.getItem(Ne));const o=e&&N.some(a=>String(a.id)===String(e)),n=String(o?e:N[0].id);t.value=n}function Z(){const t=(i("searchMine")?.value||"").toLowerCase().trim();Vt=t?V.filter(e=>`${e.title} ${e.artist} ${e.album||""}`.toLowerCase().includes(t)):V,qe()}function qe(){const t=i("musicTracks");t&&(t.innerHTML="",Vt.forEach(e=>{const o=document.createElement("div");o.className="item",o.innerHTML=`
      <div class="left trackLeft">
        <img class="trackArt" src="${L(e.artworkUrl||"")}" alt="" loading="lazy" />
        <div class="trackText">
          <div class="title">${L(e.title)}</div>
          <div class="meta">${L(e.artist)} • ${L(e.album||"")} • ${st(e.durationMs)}</div>
        </div>
      </div>
      <div class="actions">
        <button data-add="${e.id}">+ Add</button>
      </div>
    `;const n=o.querySelector(".trackArt");n&&(n.onerror=()=>{n.style.display="none"},e.artworkUrl||(n.style.display="none")),o.querySelector("[data-add]").addEventListener("click",()=>je(e)),t.appendChild(o)}))}async function Oe(){const{playlists:t}=await I(()=>Promise.resolve().then(()=>$),void 0).then(o=>o.loadSpotifyPlaylistsAndTracks());N=t,gt();const e=i("musicPlaylists").value;if(e){const{tracks:o}=await I(()=>Promise.resolve().then(()=>$),void 0).then(n=>n.loadSpotifyTracks(e));V=o,Z()}}async function Fe(t){const{tracks:e}=await I(()=>Promise.resolve().then(()=>$),void 0).then(o=>o.loadSpotifyTracks(t));V=e,Z()}async function Ke(t){const{spotifyFindUriForTrack:e}=await I(async()=>{const{spotifyFindUriForTrack:o}=await Promise.resolve().then(()=>$);return{spotifyFindUriForTrack:o}},void 0);return e(t)}async function Ve(){const{playlists:t,note:e}=await I(()=>Promise.resolve().then(()=>X),void 0).then(n=>n.loadApplePlaylistsAndTracks());if(e){N=[],V=[],gt(),Z(),i("sessionMeta").textContent=e;return}N=t,gt();const o=i("musicPlaylists")?.value;o&&await Qt(o)}async function Qt(t){const{tracks:e}=await I(()=>Promise.resolve().then(()=>X),void 0).then(o=>o.loadAppleTracks(t));V=e,Z()}async function D(){return P==="itunes"?loadItunesPlaylistsAndTracks():P==="spotify"?Oe():Ve()}function Jt(t){P=t,localStorage.setItem($e,P),kt(),D()}function He(t){if(S)return!0;if(tt=t,!_||_.readyState!==WebSocket.OPEN)return i("sessionMeta").textContent="Connecting… try again in a moment.",!1;if(!G){G=!0;const e=(i("displayName").value||"Host").trim().slice(0,32);if(!T("session:create",{displayName:e}))return G=!1,i("sessionMeta").textContent="Couldn’t create session (not connected).",!1;i("sessionMeta").textContent="Creating session…"}return!1}function je(t){He(t)&&T("queue:add",{sessionId:S,track:t})}function At(){const t=i("queue");if(!t)return;t.innerHTML="";const e=w&&g&&w===g;m.forEach(o=>{const n=o.track,a=document.createElement("div");a.className="item",a.innerHTML=`
      <div class="left">
        <div class="title">${L(n.title)}</div>
        <div class="meta">${L(n.artist)} • added by ${L(o.addedBy?.displayName||"someone")} • ${L(n.source||"")}</div>
      </div>
      <div class="actions">
        ${e?`<button data-play="${o.queueId}">Play</button>`:""}
        ${e?`<button data-remove="${o.queueId}">Remove</button>`:""}
      </div>
    `,e&&(a.querySelector("[data-play]").addEventListener("click",()=>x(o)),a.querySelector("[data-remove]").addEventListener("click",()=>T("queue:remove",{sessionId:S,queueId:o.queueId}))),t.appendChild(a)})}async function x(t,{isPlaying:e}={}){if(!(w&&g&&w===g))return;et=!1;const n=typeof e=="boolean"?e:!0;if(q=n,c={queueId:t.queueId,track:t.track,isPlaying:n,playheadMs:0,updatedAt:Date.now()},ut=c.queueId,T("host:state",{sessionId:S,nowPlaying:c}),E(),await rt(),n)try{d==="apple"&&await W(),d==="spotify"&&await z()}catch{}}async function Be(){if(!(w&&g&&w===g)||!m.length)return;const e=q;try{d==="apple"&&await U(),d==="spotify"&&await F()}catch{}if(!c?.queueId){await x(m[0],{isPlaying:e});return}const o=m.findIndex(a=>a.queueId===c.queueId);if(o<0){await x(m[0],{isPlaying:e});return}const n=o+1;if(n>=m.length){if(!Q)return;await x(m[0],{isPlaying:e});return}await x(m[n],{isPlaying:e})}async function Ye(){if(!(w&&g&&w===g)||!m.length)return;try{d==="spotify"&&await F(),d==="apple"&&await U()}catch{}if(!c?.queueId){await x(m[0]);return}const e=m.findIndex(n=>n.queueId===c.queueId),o=e<=0?Q?m.length-1:0:e-1;await x(m[o])}async function ze(t){if(t){if(d==="apple"){await Ft(t),ee();return}if(d==="spotify"){Ht=Date.now()+1200;const e=await Ke(t);if(!e)throw new Error("Could not find this track on Spotify via search.");J=e,await Nt(e),Zt();return}}}async function rt(){if(!c?.track)return;const t=`${c.queueId}:${d}`;if(!c.isPlaying){try{d==="apple"?await U():await F()}catch{}return}if(t===wt){try{await z()}catch{}return}wt=t,ut=c.queueId;try{await Xt(),await ze(c.track)}catch(e){i("sessionMeta").textContent=`Playback sync failed (${d}): ${e?.message||String(e)}`}}async function Xt(){te?.(),St?.();try{await F()}catch{}try{await U()}catch{}}let nt=null;async function Zt(){const t=Math.max(0,Ht-Date.now());if(t>0){setTimeout(()=>Zt(),t+50);return}te(),nt=setInterval(async()=>{try{const{spotifyGetPlaybackState:e}=await I(async()=>{const{spotifyGetPlaybackState:s}=await Promise.resolve().then(()=>$);return{spotifyGetPlaybackState:s}},void 0),o=await e(),n=o?.track_window?.current_track?.uri||"";if(J&&n&&n!==J||!o||d!=="spotify"||!c?.track||R||!c?.queueId||c.queueId!==ut)return;const a=Number(o.duration||0),u=Math.max(0,Math.min(Number(o.position||0),a||1/0)),r=!!o.paused;c={...c,isPlaying:!r,playheadMs:u},E()}catch{}},500)}function te(){nt&&clearInterval(nt),nt=null}let ot=null;function St(){ot&&clearInterval(ot),ot=null}async function ee(){St(),ot=setInterval(async()=>{try{if(d!=="apple"||!c?.track||R||c.queueId!==ut)return;const{appleGetPlaybackState:t}=await I(async()=>{const{appleGetPlaybackState:o}=await Promise.resolve().then(()=>X);return{appleGetPlaybackState:o}},void 0),e=await t();if(!e)return;c={...c,playheadMs:Number(e.positionMs)},E()}catch{}},500)}function Ge(t){return Math.max(0,Number(t?.playheadMs??0))}function E(){const t=i("nowPlaying");if(!t||R)return;const e=i("npTitle")||t.querySelector(".npTitle"),o=i("npSub")||t.querySelector(".npSub")||t.querySelector(".npMeta"),n=i("npBar")||t.querySelector("#npBar")||t.querySelector(".bar"),a=i("npPlayPause"),u=i("npPos"),r=i("npDur"),s=i("npArt");if(!e||!n)return;if(!c?.track){e.textContent="Not playing",o&&(o.textContent=""),s&&(s.src="",s.style.display="none"),n.style.width="0%";return}const l=c.track,p=Math.max(0,Number(l.durationMs||0));let f=Ge(c);if(p>0&&(f=Math.max(0,Math.min(f,p))),u&&(u.textContent=st(f)),r&&(r.textContent=st(l.durationMs||0)),s&&(s.src=l.artworkUrl||"",s.style.display=l.artworkUrl?"block":"none"),e.textContent=l.title||"Unknown title",a&&(a.textContent=c.isPlaying?"❚❚":"▶"),o){const C=l.source==="spotify"?"Spotify":l.source==="apple"?"Apple Music":l.source==="itunes"?"iTunes":l.source||"";o.textContent=`${l.artist||""}${l.album?` • ${l.album}`:""}${C?` • ${C}`:""}`}const y=Math.max(0,Math.min(1,f/p));n.style.width=`${y*100}%`;const h=i("npThumb");h&&(h.style.left=`${y*100}%`)}function We(){const t=i("playbackSource");t&&(t.value=d)}let dt=null;function Qe(){dt&&clearInterval(dt),dt=setInterval(async()=>{if(!(!(w&&g&&w===g)||!S)&&c?.track&&m?.length&&!et){(c.queueId!==_t||d!==Tt)&&(_t=c.queueId,Tt=d,H=0,j=0,et=!1);try{let e=null,o=Number(c.track.durationMs);const n=500;let a=!0,u=!1;if(d==="spotify"){const{spotifyGetPlaybackState:r}=await I(async()=>{const{spotifyGetPlaybackState:l}=await Promise.resolve().then(()=>$);return{spotifyGetPlaybackState:l}},void 0),s=await r();if(s){const l=s?.track_window?.current_track?.uri||"";if(J&&l&&l!==J)return;e=Number(s.position),o=Number(s.duration),a=!s.paused,e>j&&(j=e),!a&&e<1e3&&o>1e4&&j>=o-n&&(u=!0)}else return}if(d==="apple"){const{appleGetPlaybackState:r}=await I(async()=>{const{appleGetPlaybackState:y}=await Promise.resolve().then(()=>X);return{appleGetPlaybackState:y}},void 0),s=await r();if(!s)return;const l=Number(s.positionMs),p=Number(s.durationMs);p>1e3&&(o=p),e=l,a=!!s.isPlaying,e>H&&(H=e),console.log(e),a=!!s.isPlaying;const f=o>1e4&&e>=o-n;!a&&f&&(u=!0),!a&&e<1e3&&o>1e4&&H>=o-n&&(u=!0)}if(!u)return;et=!0,await Xe(),H=0,j=0}catch{}}},500)}function Je(){setInterval(()=>{R||d!=="spotify"&&d!=="apple"&&E()},500)}async function Xe(){if(!(w&&g&&w===g))return;const e=q;try{d==="apple"?await U():d==="spotify"&&await F()}catch{}q=e,await Kt()}function Ze(){const t=()=>w&&g&&w===g;i("createSession")?.addEventListener("click",()=>{const n=(i("displayName").value||"Host").trim().slice(0,32);T("session:create",{displayName:n})}),i("joinSession")?.addEventListener("click",()=>{const n=(i("displayName").value||"Guest").trim().slice(0,32),a=(i("joinCode").value||"").trim().toUpperCase();a&&T("session:join",{sessionId:a,displayName:n})}),i("copySession")?.addEventListener("click",async()=>{if(!S)return;if(await Bt(Yt())){const a=i("copySession"),u=a.textContent;a.textContent="Copied!",setTimeout(()=>a.textContent=u,1200)}else i("sessionMeta").textContent="Couldn’t copy to clipboard."}),i("sourceSpotify")?.addEventListener("click",()=>Jt("spotify")),i("sourceApple")?.addEventListener("click",async()=>{P="apple",localStorage.setItem("syncsong:lastSource",P),kt(),await D()}),i("reloadMusic")?.addEventListener("click",D),i("musicPlaylists")?.addEventListener("change",async()=>{const n=i("musicPlaylists").value;P==="spotify"?await Fe(n):await Qt(n)}),i("searchMine")?.addEventListener("input",Z),i("toggleLoop")?.addEventListener("click",()=>{Q=!Q,Wt()}),i("npPlayPause")?.addEventListener("click",async()=>{if(!t())return;if(!c?.queueId&&m.length){await x(m[0]);return}if(!c?.track)return;const n=!c.isPlaying;q=n;try{d==="apple"?n?await W():await U():d==="spotify"&&(n?await z():await F())}catch(a){console.warn("[play/pause] provider command failed",a)}c={...c,isPlaying:n,playheadMs:Number(c.playheadMs||0),updatedAt:Date.now()},T("host:state",{sessionId:S,nowPlaying:c}),E()}),i("npNext")?.addEventListener("click",async()=>{t()&&(q=!!c?.isPlaying,await Kt())}),i("npPrev")?.addEventListener("click",async()=>{if(!t())return;const n=q;if(await xe(),n)try{d==="apple"?await W():d==="spotify"&&await z()}catch{}});const e=i("nowPlaying")?.querySelector(".npProgress");if(e){let n=!1;const a=r=>{const s=e.getBoundingClientRect(),l=r.touches?r.touches[0].clientX:r.clientX;return Math.max(0,Math.min(1,(l-s.left)/s.width))},u=r=>{const s=c?.track?.durationMs||0;if(!s)return;const l=s*r;i("npBar")&&(i("npBar").style.width=`${r*100}%`),i("npPos")&&(i("npPos").textContent=st(l)),i("npThumb")&&(i("npThumb").style.left=`${r*100}%`)};e.addEventListener("mousedown",async r=>{if(!(!t()||!c)){if(R=!0,pt=!!c.isPlaying,pt&&c.track?.source!=="itunes")try{await F()}catch{}n=!0,Et(!0),u(a(r))}}),window.addEventListener("mousemove",r=>{n&&u(a(r))}),window.addEventListener("mouseup",async r=>{if(!n)return;if(n=!1,!t()||!c){R=!1;return}const s=a(r),l=c.track?.durationMs||0;if(l){const p=l*s/1e3;if(await Le(p),pt&&c.track?.source!=="itunes")try{await z()}catch{}const f=Math.floor(p*1e3);c={...c,playheadMs:f,updatedAt:Date.now()},T("host:state",{sessionId:S,nowPlaying:c}),E()}R=!1,Et(!1),E()})}window.addEventListener("message",n=>{if(n.origin!==window.location.origin)return;const a=n.data;if(!a||a.type!=="spotify:token"||!a.token)return;const u=a.token;localStorage.setItem("spotify:access_token",u.access_token||""),localStorage.setItem("spotify:refresh_token",u.refresh_token||""),localStorage.setItem("spotify:expires_at",String(Date.now()+(u.expires_in||0)*1e3)),console.log("[spotify] token received via postMessage")});function o({timeoutMs:n=6e4}={}){return new Promise((a,u)=>{const r=Date.now(),s=setInterval(()=>{const l=localStorage.getItem("spotify:access_token");l?(clearInterval(s),a(l)):Date.now()-r>n&&(clearInterval(s),u(new Error("Timed out waiting for Spotify token.")))},200)})}i("connectSpotify")?.addEventListener("click",async()=>{try{if(!window?.api?.spotifyConnect){const{spotifyEnsureAccessToken:a}=await I(async()=>{const{spotifyEnsureAccessToken:r}=await Promise.resolve().then(()=>$);return{spotifyEnsureAccessToken:r}},void 0);if(localStorage.getItem("spotify:refresh_token")||""){await a(),i("sessionMeta").textContent="Spotify connected!",await D();return}}const n=window?.api?.spotifyConnect;if(typeof n=="function"){const a=await n();localStorage.setItem("spotify:access_token",a.access_token),localStorage.setItem("spotify:refresh_token",a.refresh_token||""),localStorage.setItem("spotify:expires_at",String(Date.now()+a.expires_in*1e3)),i("sessionMeta").textContent="Spotify connected!",await D();return}i("sessionMeta").textContent="Opening Spotify authorization...",await I(()=>Promise.resolve().then(()=>$),void 0).then(a=>a.spotifyWebConnect()),await o(),i("sessionMeta").textContent="Spotify connected!",await D()}catch(n){console.error("[spotify] connect failed",n),i("sessionMeta").textContent="Spotify connect failed: "+(n?.message||String(n))}}),i("connectApple")?.addEventListener("click",async()=>{try{const a=await(await lt()).authorize();localStorage.setItem(Re,a),i("sessionMeta").textContent="Apple Music connected!",await D()}catch(n){i("sessionMeta").textContent="Apple connect failed: "+(n?.message||String(n))}}),i("playbackSource")?.addEventListener("change",async()=>{await Xt(),d=i("playbackSource").value,localStorage.setItem(jt,d),wt="",d==="apple"?ee():St(),await rt()})}Gt();Ze();kt();Wt();zt();We();Jt(P);Je();Qe();
